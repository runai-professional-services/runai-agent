name: Publish Helm Chart

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_call:
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  publish:
    name: Package and Publish Helm Chart
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.0'

      - name: Get chart version
        id: chart_version
        run: |
          VERSION=$(grep 'version:' deploy/helm/runai-agent/Chart.yaml | awk '{print $2}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Chart version: $VERSION"

      - name: Package Helm chart
        run: |
          mkdir -p .helm-repo
          helm package deploy/helm/runai-agent -d .helm-repo/

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Helm repository
        run: |
          # Copy new chart package to gh-pages
          cp .helm-repo/*.tgz gh-pages/
          
          # Generate/update index
          cd gh-pages
          helm repo index . --url https://${{ github.repository_owner }}.github.io/runai-agent
          
          # Commit and push
          git add .
          git commit -m "Publish Helm chart version ${{ steps.chart_version.outputs.version }}" || echo "No changes to commit"
          git push origin gh-pages

      - name: Generate summary
        run: |
          echo "## Helm Chart Published Successfully! âŽˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Chart Version:** \`${{ steps.chart_version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Usage" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Add the Helm repository" >> $GITHUB_STEP_SUMMARY
          echo "helm repo add runai-agent https://${{ github.repository_owner }}.github.io/runai-agent" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Update your local Helm chart repository cache" >> $GITHUB_STEP_SUMMARY
          echo "helm repo update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Install the chart" >> $GITHUB_STEP_SUMMARY
          echo "helm install runai-agent runai-agent/runai-agent --version ${{ steps.chart_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Repository URL" >> $GITHUB_STEP_SUMMARY
          echo "https://${{ github.repository_owner }}.github.io/runai-agent" >> $GITHUB_STEP_SUMMARY

  setup-pages:
    name: Setup GitHub Pages
    runs-on: ubuntu-latest
    needs: publish
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Enable GitHub Pages
        run: |
          echo "GitHub Pages should be enabled in repository settings"
          echo "Go to: Settings > Pages > Source > Deploy from a branch (gh-pages)"
